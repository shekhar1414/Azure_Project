trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: 'terraform-variables' # Link to a variable group containing your secrets

steps:
- task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: '1.0.0' # Specify your desired Terraform version

- task: TerraformTaskV1@0
  displayName: 'Terraform Init'
  inputs:
    provider: 'azurerm'
    command: 'init'
    backendServiceArm: 'your-service-connection-name' # Replace with your Azure Service Connection
    backendAzureRmResourceGroupName: 'ACC-23377-Azure-NPRD-AICAP-RG01'
    backendAzureRmStorageAccountName: 'acc23377sa01'
    backendAzureRmContainerName: 'tfstate'
    backendAzureRmKey: 'terraform.tfstate'

- task: TerraformTaskV1@0
  displayName: 'Terraform Validate'
  inputs:
    provider: 'azurerm'
    command: 'validate'

- task: TerraformTaskV1@0
  displayName: 'Terraform Plan'
  inputs:
    provider: 'azurerm'
    command: 'plan'
    environmentServiceNameAzureRM: 'your-service-connection-name' # Replace with your Azure Service Connection
    commandOptions: '-out=tfplan'

- task: TerraformTaskV1@0
  displayName: 'Terraform Apply'
  inputs:
    provider: 'azurerm'
    command: 'apply'
    environmentServiceNameAzureRM: 'your-service-connection-name' # Replace with your Azure Service Connection
    commandOptions: '-auto-approve tfplan'
