trigger:
- master

pool:
  name: Default

variables:
- group: 'ACC-23377-AZURE-NPRD-AICAP' # Link to a variable group containing your secrets

steps:


- task: TerraformTaskV1@0
  displayName: 'Terraform Init'
  inputs:
    provider: 'azurerm'
    command: 'init'
    backendServiceArm: 'azure-terraform-connection' # Replace with your Azure Service Connection
    backendAzureRmResourceGroupName: 'ACC-23377-Azure-NPRD-AICAP-RG01'
    backendAzureRmStorageAccountName: 'acc23377sa01'
    backendAzureRmContainerName: 'tfstate'
    backendAzureRmKey: 'terraform.tfstate'

- task: TerraformTaskV1@0
  displayName: 'Terraform Validate'
  inputs:
    provider: 'azurerm'
    command: 'validate'

- task: TerraformTaskV1@0
  displayName: 'Terraform Plan'
  inputs:
    provider: 'azurerm'
    command: 'plan'
    environmentServiceNameAzureRM: 'azure-terraform-connection' # Replace with your Azure Service Connection
    commandOptions: '-out=tfplan'
  env:
    TF_VAR_admin_password: $(admin_password)

- task: TerraformTaskV1@0
  displayName: 'Terraform Apply'
  inputs:
    provider: 'azurerm'
    command: 'apply'
    environmentServiceNameAzureRM: 'azure-terraform-connection' # Replace with your Azure Service Connection
    commandOptions: '-auto-approve tfplan'
  env:
    TF_VAR_admin_password: $(admin_password)